<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Robot Control</title>
    <link href="joy.css" rel="stylesheet" type="text/css"> <!-- Include the CSS file for the joystick -->

    <script>
        var ip_add = "{{ ip_address }}"; // Get the IP address from Flask
        var form_send = ip_add + "/control";

        function sendData() {
            var form = document.getElementById("robotControlForm");
            var sliders = form.getElementsByTagName("input");
            var L_Motors = document.getElementById("L_Motors").value;
            var R_Motors = document.getElementById("R_Motors").value;
            var formData = new FormData();

            // Loop through sliders, add their values to formData
            for (var i = 0; i < sliders.length; i++) {
                if (sliders[i].type === "range") {
                    formData.append(sliders[i].name, sliders[i].value);
                }
            }

            // Add joystick values to formData
            formData.append("L_Motors", L_Motors);
            formData.append("R_Motors", R_Motors);

            // Send formData to the Flask backend
            fetch("/control", {
                method: "POST",
                body: formData
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Network response was not ok");
                    }
                    return response.text();
                })
                .then(data => {
                    console.log(data); // Log the response from the backend
                })
                .catch(error => {
                    console.error("There was a problem with the fetch operation:", error);
                });
        }

        // Function to call sendData() whenever the input event occurs on sliders or joysticks
        function bindInputEvents() {
            var form = document.getElementById("robotControlForm");
            form.action = form_send;
            var inputs = form.getElementsByTagName("input");
            for (var i = 0; i < inputs.length; i++) {
                if (inputs[i].type === "range") {
                    inputs[i].addEventListener("input", sendData);
                }
            }

        }

        // Bind input events when the document is loaded
        document.addEventListener("DOMContentLoaded", bindInputEvents);

        function updateDashboard() {
            var sliders = document.querySelectorAll('input[type="range"]');


            var dashboardContent = "";
            sliders.forEach(function (slider) {
                dashboardContent += "<p>" + slider.name + ": " + slider.value + "</p>";
            });


            document.getElementById("sliderValues").innerHTML = dashboardContent;
            sendData();
        }


        // Bind input events when the document is loaded
        document.addEventListener("DOMContentLoaded", function () {
            bindInputEvents();
            updateDashboard(); // Update dashboard initially
        });
    </script>
    <style>
        /* Styles for head sliders */
        #head_sliders {
            background-color: chocolate;
            width: 250px;
            margin-bottom: 20px;
        }

        /* Styles for left arm sliders */
        #L_arm_sliders {
            background-color: salmon;
            width: 250px;
            margin-right: 20px;
        }

        /* Styles for right arm sliders */
        #R_arm_sliders {
            background-color: salmon;
            width: 250px;
        }

        /* Styles for body sliders */
        #body_sliders {
            background-color: dodgerblue;
            width: 250px;
            margin-bottom: 20px;
        }

        /* Styles for wheel sliders */
        #Wheel_Sliders {
            background-color: darkgreen;
            width: 250px;
        }

        #outer {
            background-color: darkgray;
            width: 600px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #upper {
            display: flex;
            flex-direction: row;
            margin-bottom: 20px;
        }

        #base {
            display: flex;
            flex-direction: row;
            padding: 20px;
            align-content: center;
            align-items: center;
        }


        #strip {
            display: flex;
            flex-direction: column;
            align-items: center;
            align-content: center;
        }

        #strip {
            display: flex;
            flex-direction: column;
            align-items: center;
            align-content: center;
        }

        #dashboard {
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 20px;
        }

        #dashboard h3 {
            margin-top: 0;
            margin-bottom: 10px;
        }

        #sliderValues p {
            margin: 5px 0;
        }

        .button-container {
            text-align: center;
            background-color: #575757;
            width: 600px;
            height: auto;
        }

        .button-container button {
            margin: 0 5px; /* Adjust the margin as needed */
            background-color: #2d2a2a;
            color: darkgoldenrod;
            width: 40px;
            height: auto;
        }
    </style>
</head>
<body>
<h2>Robot Control Interface</h2>
<div id="base">
    <div>
        <iframe id="dummyframe" name="dummyframe" style="display: none;"></iframe>
        <form action="http://192.168.88.58:3245/control" id="robotControlForm" method="post" target="dummyframe">
            <div id="outer">
                <div id="head_sliders">
                    <label for="slider1">HeadTilt:</label>
                    <input id="slider1" max="9000" min="3000" name="HeadTilt" step="200" type="range" value="6000"><br>

                    <label for="slider2">HeadTurn:</label>
                    <input id="slider2" max="9000" min="3000" name="HeadTurn" step="200" type="range" value="6000"><br>
                </div>
                <div id="upper">
                    <div id="L_arm_sliders">
                        <label for="slider3">LShoulder:</label>
                        <input id="slider3" max="9000" min="3000" name="LShoulder" step="200" type="range" value="6000"><br>

                        <label for="slider4">LBicep</label>
                        <input id="slider4" max="9000" min="3000" name="LBicep" step="200" type="range"
                               value="6000"><br>

                        <label for="slider5">Lelbow</label>
                        <input id="slider5" max="9000" min="3000" name="Lelbow" step="200" type="range"
                               value="6000"><br>

                        <label for="slider6">Lwrist</label>
                        <input id="slider6" max="9000" min="3000" name="Lwrist" step="200" type="range"
                               value="6000"><br>

                        <label for="slider7">Lclaw</label>
                        <input id="slider7" max="9000" min="3000" name="Lclaw" step="200" type="range" value="6000"><br>
                    </div>

                    <div id="R_arm_sliders">
                        <label for="slider8">RShoulder</label>
                        <input id="slider8" max="9000" min="3000" name="Rshoulder" step="200" type="range" value="6000"><br>

                        <label for="slider9">RBicep</label>
                        <input id="slider9" max="9000" min="3000" name="RBicep" step="200" type="range"
                               value="6600"><br>

                        <label for="slider10">Relbow</label>
                        <input id="slider10" max="9000" min="3000" name="Relbow" step="200" type="range"
                               value="6000"><br>

                        <label for="slider11">Rwrist</label>
                        <input id="slider11" max="9000" min="3000" name="Rwrist" step="200" type="range"
                               value="6000"><br>

                        <label for="slider12">Rclaw</label>
                        <input id="slider12" max="9000" min="3000" name="Rclaw" step="200" type="range"
                               value="6000"><br>
                    </div>

                </div>
                <div id="Wheel_Sliders">
                    <div id="body_sliders">
                        <label for="slider13">Waist:</label>
                        <input id="slider13" max="9000" min="3000" name="Waist" step="200" type="range"
                               value="6000"><br>
                    </div>
                    <label for="L_Motors">L_Motor</label>
                    <input id="L_Motors" max="9000" min="3000" name="L_Motors" step="200" type="range" value="6000"><br>
                    <label for="R_Motors">R_Motor</label>
                    <input id="R_Motors" max="9000" min="3000" name="R_Motors" step="200" type="range" value="6000"><br>
                </div>
                <input onclick="sendData()" type="button" value="Send">
            </div>
        </form>
        <div class="button-container">
            <button onclick="window.location.href='url1';">Button 1</button>
            <button onclick="window.location.href='url2';">Button 2</button>
            <button onclick="window.location.href='url3';">Button 3</button>
            <button onclick="window.location.href='url4';">Button 4</button>
            <button onclick="window.location.href='url5';">Button 5</button>
            <button onclick="window.location.href='url6';">Button 6</button>
            <button onclick="window.location.href='url7';">Button 7</button>
            <button onclick="window.location.href='url8';">Button 8</button>
        </div>

    </div>
    <div id="strip">
        <div id="dashboard">
            <h3>Slider Values</h3>
            <div id="sliderValues">
                <!-- Slider values will be displayed here dynamically -->
            </div>
        </div>
        <div id="joyDiv" style=" width: 100px; height: 100px; background-color: #7700FF">
            <script src="joy.js"></script>
            <script>
                var joy = new JoyStick('joyDiv', {
                    // The ID of canvas element
                    title: 'joystick',
                    // width/height
                    width: undefined,
                    height: undefined,
                    // Internal color of Stick
                    internalFillColor: '#00AA00',
                    // Border width of Stick
                    internalLineWidth: 2,
                    // Border color of Stick
                    internalStrokeColor: '#003300',
                    // External reference circonference width
                    externalLineWidth: 2,
                    //External reference circonference color
                    externalStrokeColor: '#008000',
                    // Sets the behavior of the stick
                    autoReturnToCenter: true

                });

                // Get the joystick element
                var joyStickElement = document.getElementById("joyDiv");

                // Variable to track whether the joystick is being dragged
                var isDragging = false;

                // Add mousedown event listener to start tracking drag
                joyStickElement.addEventListener("mousedown", function (event) {
                    isDragging = true;
                    <!---add async while loop here-->
                });

                // Add mousemove event listener to update motor values while dragging
                document.addEventListener("mousemove", function (event) {
                    if (isDragging) {
                        // Extract the joystick values based on mouse position
                        var joyStickRect = joyStickElement.getBoundingClientRect();
                        var xValue = event.clientX - joyStickRect.left;
                        var yValue = event.clientY - joyStickRect.top;

                        // Update the "L_Motors" and "R_Motors" values based on joystick position
                        var {L_Motors, R_Motors} = mapJoystickToMotors(xValue, yValue);

                        // Update the input fields with the new values
                        document.getElementById("L_Motors").value = L_Motors;
                        document.getElementById("R_Motors").value = R_Motors;
                        updateDashboard();
                    }
                });

                // Add mouseup event listener to stop tracking drag
                document.addEventListener("mouseup", function (event) {
                    isDragging = false;
                    document.getElementById("L_Motors").value = 6000;
                    document.getElementById("R_Motors").value = 6000;
                    updateDashboard();
                });

                function RsmoothStep(angle) {
                    // Normalize angle to be between 0 and 2*pi
                    angle = ((angle % (2 * Math.PI)) + 2 * Math.PI) % (2 * Math.PI);

                    // Check which range the angle falls into
                    if (angle >= -Math.PI / 4 && angle <= Math.PI / 4) {
                        return 0;
                    } else if (angle > Math.PI / 4 && angle < 3 * Math.PI / 4) {
                        return (angle - Math.PI / 4) / (Math.PI / 2);
                    } else if (angle >= 3 * Math.PI / 4 && angle <= 5 * Math.PI / 4) {
                        return 1;
                    } else if (angle > 5 * Math.PI / 4 && angle < 7 * Math.PI / 4) {
                        return 1 - ((angle - 5 * Math.PI / 4) / (Math.PI / 2));
                    } else {
                        return 0;
                    }
                }

                function LsmoothStep(angle) {
                    // Normalize angle to be between 0 and 2*pi
                    angle = ((angle % (2 * Math.PI)) + 2 * Math.PI) % (2 * Math.PI);

                    // Check which range the angle falls into
                    if (angle >= -Math.PI / 4 && angle <= Math.PI / 4) {
                        return 1;
                    } else if (angle > Math.PI / 4 && angle < 3 * Math.PI / 4) {
                        return 1 - (angle - Math.PI / 4) / (Math.PI / 2);
                    } else if (angle >= 3 * Math.PI / 4 && angle <= 5 * Math.PI / 4) {
                        return 0;
                    } else if (angle > 5 * Math.PI / 4 && angle < 7 * Math.PI / 4) {
                        return (angle - 5 * Math.PI / 4) / (Math.PI / 2);
                    } else {
                        return 1;
                    }
                }


                function signFunction(angle) {
                    // Normalize angle to be between 0 and 2*pi
                    angle = ((angle % (2 * Math.PI)) + 2 * Math.PI) % (2 * Math.PI);

                    // Check if angle is between 0 and pi or between pi and 2*pi
                    if (angle >= 0 && angle <= Math.PI) {
                        return -1 * Math.sin(angle);
                    } else {
                        return 1 * Math.abs(Math.sin(angle));
                    }
                }


                // Define your logic to map joystick position to motor values
                function mapJoystickToMotors(x, y) {
                    // Example logic:
                    // Map x and y values to motor speeds

                    // Calculate the maximum distance from the center (radius) of the joystick
                    var radius = joyStickElement.offsetWidth / 2;

                    // Calculate the distance of the joystick from the center
                    var distance = Math.sqrt(Math.pow(x - radius, 2) + Math.pow(y - radius, 2));

                    // Normalize the distance to be within the range of 0 to 1
                    var normalizedDistance = distance / radius;
                    // console.log("Norm.Distance: " + normalizedDistance)
                    // Calculate the angle of the joystick (in radians)
                    var angle = Math.atan2(y - radius, x - radius);
                    // console.log("Angle(rad): " + angle)

                    // Map x and y values to motor speeds
                    // For simplicity, let's assume full power is 8000
                    var L_Motors = 6000 + 2000 * normalizedDistance * LsmoothStep(angle) * signFunction(angle);
                    var R_Motors = 6000 + 2000 * normalizedDistance * RsmoothStep(angle) * signFunction(angle);

                    // Adjust motor values if they go beyond the range of 3000 to 9000
                    updateDashboard();
                    return {L_Motors: L_Motors, R_Motors: R_Motors};
                }


            </script>
        </div>

    </div>

</div>
</body>
</html>
