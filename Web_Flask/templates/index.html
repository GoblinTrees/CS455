<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Robot Control</title>
    <script>
        var ip_add = "{{ ip_address }}"; // Get the IP address from Flask
        var form_send = ip_add + "/control";

        function sendData() {
            var form = document.getElementById("robotControlForm");
            var sliders = form.getElementsByTagName("input");
            var L_Motors = document.getElementById("L_Motors").value;
            var R_Motors = document.getElementById("R_Motors").value;
            var formData = new FormData();

            // Loop through sliders, add their values to formData
            for (var i = 0; i < sliders.length; i++) {
                if (sliders[i].type === "range") {
                    formData.append(sliders[i].name, sliders[i].value);
                }
            }

            // Add joystick values to formData
            formData.append("L_Motors", L_Motors);
            formData.append("R_Motors", R_Motors);

            // Send formData to the Flask backend
            fetch("/control", {
                method: "POST",
                body: formData
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Network response was not ok");
                    }
                    return response.text();
                })
                .then(data => {
                    console.log(data); // Log the response from the backend
                })
                .catch(error => {
                    console.error("There was a problem with the fetch operation:", error);
                });
            updateDashboard();
        }

        // Function to call sendData() whenever the input event occurs on sliders or joysticks
        function bindInputEvents() {
            var form = document.getElementById("robotControlForm");
            form.action = form_send;
            var inputs = form.getElementsByTagName("input");
            for (var i = 0; i < inputs.length; i++) {
                if (inputs[i].type === "range") {
                    inputs[i].addEventListener("input", sendData);
                }
            }

        }

        // Bind input events when the document is loaded
        document.addEventListener("DOMContentLoaded", bindInputEvents);
    </script>
    <style>
        /* Styles for head sliders */
        #head_sliders {
            background-color: chocolate;
            width: 250px;
            margin-bottom: 20px;
        }

        /* Styles for left arm sliders */
        #L_arm_sliders {
            background-color: salmon;
            width: 250px;
            margin-right: 20px;
        }

        /* Styles for right arm sliders */
        #R_arm_sliders {
            background-color: salmon;
            width: 250px;
        }

        /* Styles for body sliders */
        #body_sliders {
            background-color: dodgerblue;
            width: 250px;
            margin-bottom: 20px;
        }

        /* Styles for wheel sliders */
        #Wheel_Sliders {
            background-color: darkgreen;
            width: 250px;
        }

        #outer {
            background-color: darkgray;
            width: 600px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #upper {
            display: flex;
            flex-direction: row;
            margin-bottom: 20px;
        }

        #base {
            display: flex;
            flex-direction: row;
            padding: 20px;
            align-content: center;
            align-items: center;
        }

        #joystick {
            width: 200px;
            height: 200px;
            background: #f0f0f0;
            border-radius: 50%;
            position: relative;
            cursor: pointer;
            touch-action: none;
        }

        #joystick-handle {
            width: 50px;
            height: 50px;
            background: #333;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        #strip {
            display: flex;
            flex-direction: column;
            align-items: center;
            align-content: center;
        }

        #strip {
            display: flex;
            flex-direction: column;
            align-items: center;
            align-content: center;
        }

        #dashboard {
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 20px;
        }

        #dashboard h3 {
            margin-top: 0;
            margin-bottom: 10px;
        }

        #sliderValues p {
            margin: 5px 0;
        }

    </style>
</head>
<body>
<h2>Robot Control Interface</h2>
<div id="base">
    <iframe id="dummyframe" name="dummyframe" style="display: none;"></iframe>
    <form action="http://192.168.88.58:3245/control" id="robotControlForm" method="post" target="dummyframe">
        <div id="outer">
            <div id="head_sliders">
                <label for="slider1">HeadTilt:</label>
                <input id="slider1" max="9000" min="3000" name="HeadTilt" step="200" type="range" value="6000"><br>

                <label for="slider2">HeadTurn:</label>
                <input id="slider2" max="9000" min="3000" name="HeadTurn" step="200" type="range" value="6000"><br>
            </div>
            <div id="upper">
                <div id="L_arm_sliders">
                    <label for="slider3">LShoulder:</label>
                    <input id="slider3" max="9000" min="3000" name="LShoulder" step="200" type="range" value="6000"><br>

                    <label for="slider4">LBicep</label>
                    <input id="slider4" max="9000" min="3000" name="LBicep" step="200" type="range" value="6000"><br>

                    <label for="slider5">Lelbow</label>
                    <input id="slider5" max="9000" min="3000" name="Lelbow" step="200" type="range" value="6000"><br>

                    <label for="slider6">Lwrist</label>
                    <input id="slider6" max="9000" min="3000" name="Lwrist" step="200" type="range" value="6000"><br>

                    <label for="slider7">Lclaw</label>
                    <input id="slider7" max="9000" min="3000" name="Lclaw" step="200" type="range" value="6000"><br>
                </div>

                <div id="R_arm_sliders">
                    <label for="slider8">RShoulder</label>
                    <input id="slider8" max="9000" min="3000" name="Rshoulder" step="200" type="range" value="6000"><br>

                    <label for="slider9">RBicep</label>
                    <input id="slider9" max="9000" min="3000" name="RBicep" step="200" type="range" value="6000"><br>

                    <label for="slider10">Relbow</label>
                    <input id="slider10" max="9000" min="3000" name="Relbow" step="200" type="range" value="6000"><br>

                    <label for="slider11">Rwrist</label>
                    <input id="slider11" max="9000" min="3000" name="Rwrist" step="200" type="range" value="6000"><br>

                    <label for="slider12">Rclaw</label>
                    <input id="slider12" max="9000" min="3000" name="Rclaw" step="200" type="range" value="6000"><br>
                </div>

            </div>
            <div id="Wheel_Sliders">
                <div id="body_sliders">
                    <label for="slider13">Waist:</label>
                    <input id="slider13" max="9000" min="3000" name="Waist" step="200" type="range" value="6000"><br>
                </div>
                <label for="L_Motors">L_Motor</label>
                <input id="L_Motors" max="8000" min="4000" name="L_Motors" step="200" type="range" value="6000"><br>
                <label for="R_Motors">R_Motor</label>
                <input id="R_Motors" max="8000" min="4000" name="R_Motors" step="200" type="range" value="6000"><br>
            </div>
            <input onclick="sendData()" type="button" value="Send">
        </div>
    </form>
    <div id="strip">
        <div id="dashboard">
            <h3>Slider Values</h3>
            <div id="sliderValues">
                <!-- Slider values will be displayed here dynamically -->
            </div>
        </div>
        <div id="joystick">
            <div id="joystick-handle"></div>
        </div>
    </div>
    <script>
        const joystick = document.getElementById('joystick');
        const handle = document.getElementById('joystick-handle');
        let isDragging = false;

        joystick.addEventListener('mousedown', startDrag);
        joystick.addEventListener('touchstart', startDrag);

        document.addEventListener('mouseup', endDrag);
        document.addEventListener('touchend', endDrag);

        document.addEventListener('mousemove', drag);
        document.addEventListener('touchmove', drag);

        function startDrag(e) {
            console.log("starting drag...");
            e.preventDefault();
            isDragging = true;
            updateDashboard();
        }

        function endDrag() {
            isDragging = false;
            cosole.log("ending drag...")

            // Get joystick handle position
            var handlePositionX = parseFloat(handle.style.left) || 0;
            var handlePositionY = parseFloat(handle.style.top) || 0;
            console.log("X pos: " + handlePositionX);
            console.log("Y pos: " + handlePositionY)    

            // Determine the direction of joystick movement
            var directionX = handlePositionX > 0 ? 1 : -1; // Right (positive) or Left (negative)
            var directionY = handlePositionY > 0 ? 1 : -1; // Down (positive) or Up (negative)

            // Calculate L_Motors and R_Motors based on joystick movement
            var L_Motors, R_Motors;
            if (Math.abs(handlePositionX) > Math.abs(handlePositionY)) {
                // Horizontal movement
                L_Motors = 6000 + 6000 * directionX; // Right: 9000, Left: 3000
                R_Motors = 6000;
            } else {
                // Vertical movement
                L_Motors = 6000;
                R_Motors = 6000 + 6000 * directionY; // Down: 3000, Up: 9000
            }

            // Update slider values
            document.getElementById("L_Motors").value = L_Motors;
            document.getElementById("R_Motors").value = R_Motors;

            //Submit form data
            document.getElementById("robotControlForm").submit();

            // Reset joystick handle position
            handle.style.transform = 'translate(-50%, -50%)';
            sendData();
            updateDashboard();
        }


        function drag(e) {
            if (!isDragging) return;

            let posX, posY;
            if (e.type === 'touchmove') {
                posX = e.touches[0].clientX - joystick.offsetLeft;
                posY = e.touches[0].clientY - joystick.offsetTop;
            } else {
                posX = e.clientX - joystick.offsetLeft;
                posY = e.clientY - joystick.offsetTop;
            }

            const joystickRect = joystick.getBoundingClientRect();
            const handleSize = handle.offsetWidth;

            // Calculate the joystick position relative to its center
            let newX = posX - joystickRect.width / 2;
            let newY = posY - joystickRect.height / 2;

            // Ensure the handle stays within the bounds of the joystick
            const distance = Math.sqrt(newX * newX + newY * newY);
            if (distance > joystickRect.width / 2 - handleSize / 2) {
                const angle = Math.atan2(newY, newX);
                newX = Math.cos(angle) * (joystickRect.width / 2 - handleSize / 2);
                newY = Math.sin(angle) * (joystickRect.height / 2 - handleSize / 2);
            }
            updateDashboard();
            // Move the handle
            handle.style.transform = `translate(${newX}px, ${newY}px)`;
        }


        function updateDashboard() {
            var sliders = document.querySelectorAll('input[type="range"]');


            var dashboardContent = "";
            sliders.forEach(function (slider) {
                dashboardContent += "<p>" + slider.name + ": " + slider.value + "</p>";
            });


            document.getElementById("sliderValues").innerHTML = dashboardContent;
        }


        // Bind input events when the document is loaded
        document.addEventListener("DOMContentLoaded", function () {
            bindInputEvents();
            updateDashboard(); // Update dashboard initially
        });
    </script>

</div>
</div>
</body>
</html>
